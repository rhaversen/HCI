<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="/styles.css" />
    <title>WarpTalk Rasmus Haversen</title>
    <script src="./WarpTalk client example_files/warptalk.js" type="application/javascript"></script>
</head>

<body>
    <div class="grid">
        <section class="roomsContainer">
            <header class="header">
                <span>Rooms</span>
            </header>
            <div class="rooms">
                <div class="subHeader">Joined Rooms</div>
                <div class="joinedRooms"></div>

                <div class="subHeader">Available Rooms</div>
                <div class="availableRooms"></div>
            </div>
        </section>

        <section class="messagesContainer">
            <header class="header">
                <span id="roomNameHeader">No Room Opened</span>
            </header>
            <div class="messages"></div>
            <div class="composeMessage">
                <textarea class="textInput" placeholder="Input message here"></textarea>
                <button class="sendMessageButton">
                    <img class="icon" src="icons/icons8-send-message-24.png" alt="Send" />
                </button>
            </div>
        </section>

        <section class="roomInfoContainer">
            <header class="header">
                <span>Room Info</span>
            </header>
        </section>
    </div>

    <script>
        let openedRoomName;
        let messages = {};
        let user;

        // Setup WarpTalk
        let wt = new WarpTalk("wss", "warp.cs.au.dk/talk/");
        console.log("Connecting to the WarpTalk server ...");

        wt.isLoggedIn(function (isLoggedIn) {
            if (isLoggedIn) {
                // If we are already logged in we can call connect that we also give a function to call when the connection has been established
                wt.connect(connected);
            } else {
                // If not, we prompt the user for a temporary unregistered nickname
                let nickname = prompt("What's your (unregistered) nickname?");
                wt.connect(connected, nickname);
                user = nickname;
            }
        });

        // This function is called when the connection to the server is established (we give it as argument to connect above).
        function connected() {
            console.log("Connection established.");
            // We can now list the rooms available on the server
            console.log("The server has the following rooms:");
            wt.availableRooms.forEach((room) => {
                console.log(`- ${room.name}: ${room.description}`);
            });
            populateRooms();
        }

        function joinRoom(roomName) {
            const joinedRoom = wt.join(roomName);

            joinedRoom.onMessage((joinedRoom, msg) => {
                console.log(`${joinedRoom.name} - ${msg.sender}: ${msg.message}`);

                // Check if the room exists in the rooms object, if not, initialize it
                if (!messages[joinedRoom.name]) {
                    messages[joinedRoom.name] = [];
                }

                // Push the message to the specific room's array
                messages[joinedRoom.name].push(msg);
                console.log(messages)
                
                // If the opened room is this room, update the messages
                if (joinedRoom.name === openedRoomName) {
                    populateMessages();
                }
            });

            joinedRoom.onJoin((joinedRoom, nickname) => {
                console.log(`${nickname} joined ${joinedRoom.name}`);
                if (joinedRoom.name === openedRoomName) {
                    populateClients();
                }
            });

            joinedRoom.onLeave((joinedRoom, nickname) => {
                console.log(`${nickname} left ${joinedRoom.name}`);
                if (joinedRoom.name === openedRoomName) {
                    populateClients();
                }
            });

            joinedRoom.onDisconnect((joinedRoom) => {
                console.log(`Connection to server lost`);
            });

            populateRooms(); // Refresh the rooms list to reflect the changes
        }

        function openRoom(room) {
            openedRoomName = room.name;
            document.getElementById('roomNameHeader').textContent = room.name;
            populateMessages();
            populateClients();
        }

        // Code for textarea adjustment
        const textarea = document.querySelector(".textInput");
        textarea.addEventListener("input", function () {
            this.style.height = "20px";
            this.style.height = this.scrollHeight + "px";
        });

        // Messages rendering
        function populateMessages() {
            const messagesDiv = document.querySelector(".messages");

            // Clear messages
            messagesDiv.innerHTML = "";

            // Check if any messages has been received. If not, don't render any
            if (!messages[openedRoomName]) {
                return;
            }

            messages[openedRoomName].forEach(item => {
                const messageDiv = document.createElement("div");
                messageDiv.className =
                    item.sender === user ? "messageUser" : "messageOther";
                messageDiv.textContent = item.message;
                messagesDiv.appendChild(messageDiv);
            });
        }

        // Clients rendering
        function populateClients() {
            
        }

        // Rooms rendering
        function populateRooms() {
            const joinedRoomsContainer = document.querySelector(".joinedRooms");
            const availableRoomsContainer =
                document.querySelector(".availableRooms");

            // Clear any existing divs in both containers
            joinedRoomsContainer.innerHTML = "";
            availableRoomsContainer.innerHTML = "";

            wt.availableRooms.forEach((room) => {
                const roomDiv = document.createElement("div");
                roomDiv.className = "room";

                const roomDetailsDiv = document.createElement('div');
                roomDetailsDiv.className = 'roomDetails';

                const roomNameDiv = document.createElement("div");
                roomNameDiv.textContent = room.name;
                roomNameDiv.className = "roomName";

                const roomDescriptionDiv = document.createElement("div");
                roomDescriptionDiv.textContent = room.description;
                roomDescriptionDiv.className = "roomDescription";

                const actionButton = document.createElement("button");

                if (!wt.joinedRooms[room.name]) {
                    actionButton.innerHTML = '<img src="icons/icons8-enter-100.png" alt="Join" class="icon">';
                    actionButton.className = "joinRoomButton";
                    actionButton.addEventListener("click", function () {
                        console.log(`Joining room: ${room.name}`);
                        joinRoom(room.name);
                    });
                } else {
                    actionButton.innerHTML = '<img src="icons/icons8-open-128.png" alt="Open" class="icon">';
                    actionButton.className = "openRoomButton";
                    actionButton.addEventListener("click", function () {
                        console.log(`Opening room: ${room.name}`);
                        openRoom(room);
                    });
                }

                roomDetailsDiv.appendChild(roomNameDiv);
                roomDetailsDiv.appendChild(roomDescriptionDiv);

                roomDiv.appendChild(roomDetailsDiv);
                roomDiv.appendChild(actionButton);

                if (!wt.joinedRooms[room.name]) {
                    availableRoomsContainer.appendChild(roomDiv);
                } else {
                    joinedRoomsContainer.appendChild(roomDiv);
                }
            });
        }
    </script>
</body>

</html>